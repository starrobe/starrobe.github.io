import{_ as F}from"./ValaxyMain.vue_vue_type_style_index_0_lang-d8ab152d.js";import{_ as y,u as D,p as i,c as d,w as o,o as A,a as s,b as l,d as n,r as t,e as C}from"./app-2781ddff.js";import"./YunFooter.vue_vue_type_script_setup_true_lang-e8642e2c.js";import"./YunCard.vue_vue_type_script_setup_true_lang-7e7da48c.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang-ebad1ef6.js";const Xl=JSON.parse('{"title":"C++并发","description":"","frontmatter":{"layout":"post","title":"C++并发","date":"2023-07-24T11:18:24.000Z","categories":"笔记","tags":["C++","并发编程"]},"headers":[{"level":2,"title":"线程管理","slug":"线程管理","link":"#线程管理","children":[]},{"level":2,"title":"共享数据","slug":"共享数据","link":"#共享数据","children":[{"level":3,"title":"使用互斥保护数据","slug":"使用互斥保护数据","link":"#使用互斥保护数据","children":[]},{"level":3,"title":"保护数据的替代方案","slug":"保护数据的替代方案","link":"#保护数据的替代方案","children":[]}]},{"level":2,"title":"同步操作","slug":"同步操作","link":"#同步操作","children":[{"level":3,"title":"条件变量","slug":"条件变量","link":"#条件变量","children":[]},{"level":3,"title":"future","slug":"future","link":"#future","children":[]},{"level":3,"title":"锁存器和栅栏","slug":"锁存器和栅栏","link":"#锁存器和栅栏","children":[]}]},{"level":2,"title":"内存模型和原子操作","slug":"内存模型和原子操作","link":"#内存模型和原子操作","children":[{"level":3,"title":"atomic","slug":"atomic","link":"#atomic","children":[]},{"level":3,"title":"原子操作的内存序","slug":"原子操作的内存序","link":"#原子操作的内存序","children":[]},{"level":3,"title":"栅栏","slug":"栅栏","link":"#栅栏","children":[]}]}],"relativePath":"pages/posts/cplusplus-concurrency.md","path":"/home/runner/work/valaxy/valaxy/pages/posts/cplusplus-concurrency.md","lastUpdated":1692888211000}'),c=JSON.parse('{"title":"C++并发","description":"","frontmatter":{"layout":"post","title":"C++并发","date":"2023-07-24T11:18:24.000Z","categories":"笔记","tags":["C++","并发编程"]},"headers":[{"level":2,"title":"线程管理","slug":"线程管理","link":"#线程管理","children":[]},{"level":2,"title":"共享数据","slug":"共享数据","link":"#共享数据","children":[{"level":3,"title":"使用互斥保护数据","slug":"使用互斥保护数据","link":"#使用互斥保护数据","children":[]},{"level":3,"title":"保护数据的替代方案","slug":"保护数据的替代方案","link":"#保护数据的替代方案","children":[]}]},{"level":2,"title":"同步操作","slug":"同步操作","link":"#同步操作","children":[{"level":3,"title":"条件变量","slug":"条件变量","link":"#条件变量","children":[]},{"level":3,"title":"future","slug":"future","link":"#future","children":[]},{"level":3,"title":"锁存器和栅栏","slug":"锁存器和栅栏","link":"#锁存器和栅栏","children":[]}]},{"level":2,"title":"内存模型和原子操作","slug":"内存模型和原子操作","link":"#内存模型和原子操作","children":[{"level":3,"title":"atomic","slug":"atomic","link":"#atomic","children":[]},{"level":3,"title":"原子操作的内存序","slug":"原子操作的内存序","link":"#原子操作的内存序","children":[]},{"level":3,"title":"栅栏","slug":"栅栏","link":"#栅栏","children":[]}]}],"relativePath":"pages/posts/cplusplus-concurrency.md","path":"/home/runner/work/valaxy/valaxy/pages/posts/cplusplus-concurrency.md","lastUpdated":1692888211000}'),u={name:"pages/posts/cplusplus-concurrency.md",data(){return{data:c,frontmatter:c.frontmatter,$frontmatter:c.frontmatter}},setup(){const a=D();a.meta.frontmatter=Object.assign(a.meta.frontmatter,c.frontmatter),i("pageData",c)}},h=s("p",null,"参考自《C++ Concurrency In Action》",-1),_=s("li",null,"作者：Anthony Williams",-1),m={id:"线程管理",tabindex:"-1"},B=s("ul",null,[s("li",null,[s("p",null,"启动新线程"),s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Func1"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Func2"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"Foo"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"Func3"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"thread"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"t1"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"Func1"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"thread"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"t2"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"Func1"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"0"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"thread"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"t3"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"Func1"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"&"),s("span",{style:{color:"#FFCB6B"}},"Foo"),s("span",{style:{color:"#89DDFF"}},"{},"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"0"),s("span",{style:{color:"#89DDFF"}},");")])])])])]),s("li",null,[s("p",null,"等待与分离"),s("ul",null,[s("li",null,"obj.join()"),s("li",null,"obj.detach()"),s("li",null,"obj.joinable()")])]),s("li",null,[s("p",null,"唯一标识符"),s("ul",null,[s("li",null,"obj.get_id()"),s("li",null,"std::this_thread::get_id()")])]),s("li",null,[s("p",null,"其他")])],-1),f=s("p",null,[s("code",null,"std::thread::hardware_concurrency()")],-1),g={id:"共享数据",tabindex:"-1"},k={id:"使用互斥保护数据",tabindex:"-1"},x={id:"std-mutex",tabindex:"-1"},v=s("ul",null,[s("li",null,[s("code",null,"lock()")]),s("li",null,[s("code",null,"try_lock()")]),s("li",null,[s("code",null,"unlock()")])],-1),E={id:"基本用法",tabindex:"-1"},b=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"mutex m"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"m"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"lock"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"...")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"m"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"unlock"),s("span",{style:{color:"#89DDFF"}},"();")])])])],-1),w={id:"避免死锁",tabindex:"-1"},q=s("p",null,"多个互斥量锁住时，在所有地方应该以相同的顺序上锁，否则可能会造成死锁",-1),j=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"mutex m1"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"mutex m2"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Func1"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  m1"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"lock"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  m2"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"lock"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  ...")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  m2"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"unlock"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  m1"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"unlock"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Func2"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  m2"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"lock"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  m1"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"lock"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"  // 应该和Func1顺序相同")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"  // m1.lock();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"  // m2.lock();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  ...")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  m1"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"unlock"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  m2"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"unlock"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")])])])],-1),$=s("p",null,"或者一次锁住多个互斥量",-1),I=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"mutex m1"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," m2"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"lock"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"m1"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," m2"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"...")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"m1"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"unlock"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"m2"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"unlock"),s("span",{style:{color:"#89DDFF"}},"();")])])])],-1),P={id:"std-lock-guard",tabindex:"-1"},S=s("p",null,[l("互斥量的RAII模板类，不用手动"),s("code",null,"lock()"),l("与"),s("code",null,"unlock()")],-1),W=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"mutex m"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"lock_guard"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"mutex"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"lg"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"m"),s("span",{style:{color:"#89DDFF"}},");")])])])],-1),N=s("p",null,"同时，可以获取并接管锁",-1),T=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"mutex m1"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," m2"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"lock"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"m1"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," m2"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"lock_guard"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"mutex"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"lg1"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"m1"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"adopt_lock"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"lock_guard"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"mutex"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"lg2"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"m2"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"adopt_lock"),s("span",{style:{color:"#89DDFF"}},");")])])])],-1),O={id:"std-scoped-lock",tabindex:"-1"},L=s("p",null,[l("C++17中的新的RAII模板，与"),s("code",null,"std::lock_guard<>"),l("相同，不过可以接受多个互斥量，对其上锁")],-1),M=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"mutex m1"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," m2"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"scoped_lock"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"mutex"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"sl"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"m1"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"m2"),s("span",{style:{color:"#89DDFF"}},");")])])])],-1),U={id:"层级锁的实现",tabindex:"-1"},V=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"#include"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C3E88D"}},"climits"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"#include"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C3E88D"}},"mutex"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"#include"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C3E88D"}},"stdexcept"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#FFCB6B"}},"hierarchical_mutex"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#82AAFF"}},"hierarchical_mutex"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"unsigned"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#C792EA"}},"long"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"value"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"      "),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#82AAFF"}},"hierarchy_value"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F07178"}},"value"),s("span",{style:{color:"#89DDFF"}},"),"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#82AAFF"}},"previous_hierarchy_value"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F78C6C"}},"0"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#82AAFF"}},"lock"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#82AAFF"}},"check_hieratchy"),s("span",{style:{color:"#89DDFF"}},"();"),s("span",{style:{color:"#676E95","font-style":"italic"}}," // 当前互斥量的层级与当前线程的层级相比较")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#A6ACCD"}},"internal_mutex"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"lock"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#82AAFF"}},"update_hierarchy"),s("span",{style:{color:"#89DDFF"}},"();"),s("span",{style:{color:"#676E95","font-style":"italic"}}," // 将线程层级与当前层级同步")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#82AAFF"}},"unlock"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F07178"}},"this_hierarchy_value "),s("span",{style:{color:"#89DDFF"}},"!="),s("span",{style:{color:"#F07178"}}," hierarchy_value"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"      "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"throw"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"logic_error"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"mutex hierarchy violated"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    this_hierarchy_value "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#F07178"}}," previous_hierarchy_value"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#A6ACCD"}},"internal_mutex"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"unlock"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#C792EA"}},"bool"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#82AAFF"}},"try_lock"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#82AAFF"}},"check_hieratchy"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"(!"),s("span",{style:{color:"#A6ACCD"}},"internal_mutex"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"try_lock"),s("span",{style:{color:"#89DDFF"}},"())")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"      "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"false;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#82AAFF"}},"update_hierarchy"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"true;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"private"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#82AAFF"}},"check_hieratchy"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F07178"}},"hierarchy_value "),s("span",{style:{color:"#89DDFF"}},">="),s("span",{style:{color:"#F07178"}}," this_hierarchy_value"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"      "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"throw"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"logic_error"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"mutex hierarchy violated"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#82AAFF"}},"update_hierarchy"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    previous_hierarchy_value "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#F07178"}}," this_hierarchy_value"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    this_hierarchy_value "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#F07178"}}," hierarchy_value"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"private"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#F07178"}},"mutex internal_mutex"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#C792EA"}},"const"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#C792EA"}},"unsigned"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#C792EA"}},"long"),s("span",{style:{color:"#F07178"}}," hierarchy_value"),s("span",{style:{color:"#89DDFF"}},";"),s("span",{style:{color:"#676E95","font-style":"italic"}},"    // 当前锁的层级")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#C792EA"}},"unsigned"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#C792EA"}},"long"),s("span",{style:{color:"#F07178"}}," previous_hierarchy_value"),s("span",{style:{color:"#89DDFF"}},";"),s("span",{style:{color:"#676E95","font-style":"italic"}}," // 当前锁的上一层的层级")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#C792EA"}},"static"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#C792EA"}},"thread_local"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#C792EA"}},"unsigned"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#C792EA"}},"long"),s("span",{style:{color:"#F07178"}}," this_hierarchy_value"),s("span",{style:{color:"#89DDFF"}},";"),s("span",{style:{color:"#676E95","font-style":"italic"}}," // 线程的层级")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"};")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"thread_local"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"unsigned"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"long"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"hierarchical_mutex"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"this_hierarchy_value"),s("span",{style:{color:"#89DDFF"}},"{"),s("span",{style:{color:"#F07178"}},"ULONG_MAX"),s("span",{style:{color:"#89DDFF"}},"};")])])])],-1),G={id:"std-unique-lock",tabindex:"-1"},R=s("p",null,[l("与"),s("code",null,"std::lock_guard<>"),l("相似，不过前者只提供了析构接口，但"),s("code",null,"std::unique_lock<>"),l("可手动上锁，解锁更为灵活")],-1),z=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"mutex m1"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," m2"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"unique_lock"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"mutex"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"ul1"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"m1"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"defer_lock"),s("span",{style:{color:"#89DDFF"}},");"),s("span",{style:{color:"#676E95","font-style":"italic"}}," // std::defer_lock表示，不对mutex上锁")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"unique_lock"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"mutex"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"ul2"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"m2"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#676E95","font-style":"italic"}}," // m2已自动上锁")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"ul1"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"lock"),s("span",{style:{color:"#89DDFF"}},"();"),s("span",{style:{color:"#676E95","font-style":"italic"}}," // 手动上锁")])])])],-1),J={id:"保护数据的替代方案",tabindex:"-1"},X={id:"保护共享数据的初始化过程",tabindex:"-1"},Z=s("ul",null,[s("li",null,"使用互斥量")],-1),H=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"mutex m"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"shared_ptr"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#A6ACCD"}},"Widget"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," sp"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Foo"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"unique_lock"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"mutex"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"ul"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"m"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"(!"),s("span",{style:{color:"#A6ACCD"}},"sp"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#A6ACCD"}},"sp"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"reset"),s("span",{style:{color:"#89DDFF"}},"(new"),s("span",{style:{color:"#F07178"}}," Widget"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  ul"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"unlock"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  sp"),s("span",{style:{color:"#89DDFF"}},"->"),s("span",{style:{color:"#82AAFF"}},"do_something"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")])])])],-1),K=s("ul",null,[s("li",null,[s("code",null,"std::once_flag"),l("和"),s("code",null,"std::call_once")])],-1),Q=s("p",null,"比用互斥量消耗的资源更少",-1),Y=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"shared_ptr"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#A6ACCD"}},"Widget"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," sp"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"once_flag flag"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Init"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  sp"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"reset"),s("span",{style:{color:"#89DDFF"}},"(new"),s("span",{style:{color:"#A6ACCD"}}," Widget"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," Foo")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"call_once"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F07178"}},"flag"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#F07178"}}," Init"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#A6ACCD"}},"sp"),s("span",{style:{color:"#89DDFF"}},"->"),s("span",{style:{color:"#82AAFF"}},"do_something"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"// Init()只调用了一次")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"thread"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"t1"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"Foo"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"thread"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"t2"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"Foo"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"t1"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"join"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"t2"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"join"),s("span",{style:{color:"#89DDFF"}},"();")])])])],-1),ss={id:"保护不常更新的数据结构",tabindex:"-1"},ls=s("p",null,[l("C++17提供"),s("code",null,"std::shared_mutex"),l("和"),s("code",null,"std::shared_timed_mutex"),l("，C++14只提供"),s("code",null,"std::shared_timed_mutex"),l(", 而C++11并未提供。"),s("code",null,"std::shared_timed_mutex"),l("更多操作方式，"),s("code",null,"std::shared_mutex"),l("有更高的性能")],-1),os=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"shared_mutex sm"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Foo"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"  // 其他线程加锁时，不会阻塞")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"shared_lock"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"shared_mutex"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"sl"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"sm"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  ...")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Foo2"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"  // 其他线程尝试加锁时，会阻塞")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"lock_guard"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"shared_mutex"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"lg"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"sm"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  ...")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")])])])],-1),es=s("p",null,[l("并行访问数据时，使用"),s("code",null,"std::shared_lock<>"),l("上锁，所有线程都可对数据进行访问，而修改数据时， 使用"),s("code",null,"std::lock_guard<>"),l("上锁，只有一个线程可以进行修改")],-1),ns=s("p",null,[l("限制：当有线程有共享锁("),s("code",null,"std::shared_lock<>"),l("上锁)时，独占锁("),s("code",null,"std::lock_guard<>"),l(")会阻塞， 而当有线程有独占锁时，其他独占和所有共享锁都会阻塞，直到独占锁解锁")],-1),as={id:"嵌套锁",tabindex:"-1"},ts=s("p",null,[l("一个线程中"),s("code",null,"std::mutex"),l("已经上锁后，再次上锁是错误的。而"),s("code",null,"std::recursive_mutex"),l("，在同一线程可多次上锁")],-1),cs=s("p",null,[l("只不过，如果调用"),s("code",null,"lock()"),l("三次，就需要"),s("code",null,"unlock()"),l("三次，不过可以使用"),s("code",null,"std::lock_guard<std::recursive_mutex>"),l("，或者 "),s("code",null,"std::unique_lock<std::recursive_mutex>"),l("来管理")],-1),rs={id:"同步操作",tabindex:"-1"},ps={id:"条件变量",tabindex:"-1"},Fs=s("p",null,[s("code",null,"std::condition_variable"),l("或"),s("code",null,"std::condition_variable_any")],-1),ys=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"static"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"condition_variable cond"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"static"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#C792EA"}},"bool"),s("span",{style:{color:"#A6ACCD"}}," flag "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"false;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"static"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"mutex m1"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Prepare"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"lock_guard"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"mutex"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"lg"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"m1"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  flag "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"true;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  cond"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"notify_one"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Process"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"unique_lock"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"mutex"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"ul"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"m1"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  cond"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"wait"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"ul"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"[](){"),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," flag"),s("span",{style:{color:"#89DDFF"}},";});")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")])])])],-1),Ds=s("p",null,[s("code",null,"Process()"),l("中，如果"),s("code",null,"cond.wait()"),l("的第二个参数为false，会解锁ul，并令线程阻塞，等待"),s("code",null,"Process()"),l("中 的"),s("code",null,"cond.notify_one()"),l("唤醒，唤醒后ul上锁，重新判断第二个参数的值，如果仍为false，就继续阻塞")],-1),is=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"template"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"typename"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"Predicate"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"minimal_wait"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"unique_lock"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"mutex"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#C792EA"}},"&"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"lk"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"Predicate"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"pred"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"while"),s("span",{style:{color:"#89DDFF"}},"(!"),s("span",{style:{color:"#82AAFF"}},"pred"),s("span",{style:{color:"#89DDFF"}},"())")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#A6ACCD"}},"lk"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"unlock"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#A6ACCD"}},"lk"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"lock"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")])])])],-1),ds={id:"future",tabindex:"-1"},As=s("p",null,[s("code",null,"std::future<>"),l("只移动，所有权在不同实例中互相传递")],-1),Cs={id:"std-async",tabindex:"-1"},us=s("p",null,[l("启动一个异步任务与"),s("code",null,"std::tread"),l("相似，返回一个"),s("code",null,"std::future<>"),l("对象。当使用"),s("code",null,"get()"),l("或"),s("code",null,"wait()"),l("函数时，会阻塞线程，直到future就绪即std::async 完成为止")],-1),hs=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Foo"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"future"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," result "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"async"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"Foo"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"cout "),s("span",{style:{color:"#89DDFF"}},"<<"),s("span",{style:{color:"#A6ACCD"}}," result"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"<<"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"endl"),s("span",{style:{color:"#89DDFF"}},";")])])])],-1),_s=s("p",null,[s("code",null,"std::async"),l("的第一个参数有"),s("code",null,"std::launch::deferred"),l("与"),s("code",null,"std::launch::async")],-1),ms=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"future"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," result1 "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"async"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"launch"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"deferred"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," Foo"),s("span",{style:{color:"#89DDFF"}},");"),s("span",{style:{color:"#676E95","font-style":"italic"}},"  // 在当前线程同步运行，直到get或wait时，才调用函数")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"future"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," result2 "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"async"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"launch"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"async"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," Foo"),s("span",{style:{color:"#89DDFF"}},");"),s("span",{style:{color:"#676E95","font-style":"italic"}},"     // 创建新线程异步运行，表示函数必须在独立线程上执行")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"future"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," result3 "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"async"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"launc"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"deferred "),s("span",{style:{color:"#89DDFF"}},"|"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"launch"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"async"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," Foo"),s("span",{style:{color:"#89DDFF"}},");"),s("span",{style:{color:"#676E95","font-style":"italic"}}," // 由系统决定")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"result1"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"wait"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"result3"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"wait"),s("span",{style:{color:"#89DDFF"}},"();")])])])],-1),Bs=s("p",null,[s("code",null,"std::async"),l("析构时，会阻塞线程，相当于同步执行")],-1),fs=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"// 临时变量，用完后会析构，因此do_something会等到异步任务执行完才会执行")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"async"),s("span",{style:{color:"#89DDFF"}},"([]{"),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"cout "),s("span",{style:{color:"#89DDFF"}},"<<"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"hello"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"<<"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"endl"),s("span",{style:{color:"#89DDFF"}},";});")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#82AAFF"}},"do_something"),s("span",{style:{color:"#89DDFF"}},"();")])])])],-1),gs={id:"std-packaged-task",tabindex:"-1"},ks=s("p",null,[l("只是将可调用对象与future绑定，调用"),s("code",null,"std::packaged_task"),l("对象会调用绑定的可调用对象")],-1),xs=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Foo"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"packaged_task"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},"()>"),s("span",{style:{color:"#A6ACCD"}}," task "),s("span",{style:{color:"#89DDFF"}},"{"),s("span",{style:{color:"#F07178"}},"Foo"),s("span",{style:{color:"#89DDFF"}},"};")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"future"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," f "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," task"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get_future"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#82AAFF"}},"task"),s("span",{style:{color:"#89DDFF"}},"();"),s("span",{style:{color:"#676E95","font-style":"italic"}}," // 相当于执行Foo()，运行结束后f状态为就绪，即之后f.get()或f.wait()不会阻塞")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"cout "),s("span",{style:{color:"#89DDFF"}},"<<"),s("span",{style:{color:"#A6ACCD"}}," f"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"<<"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"endl"),s("span",{style:{color:"#89DDFF"}},";")])])])],-1),vs=s("p",null,"可用于线程当中",-1),Es=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Foo"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"packaged_task"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},"()>"),s("span",{style:{color:"#A6ACCD"}}," task "),s("span",{style:{color:"#89DDFF"}},"{"),s("span",{style:{color:"#F07178"}},"Foo"),s("span",{style:{color:"#89DDFF"}},"};")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"future"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," f "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," task"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get_future"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"thread"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"t"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"task"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"...")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"f"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"wait"),s("span",{style:{color:"#89DDFF"}},"();"),s("span",{style:{color:"#676E95","font-style":"italic"}}," // 阻塞线程，直到f就绪")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"...")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"t"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"join"),s("span",{style:{color:"#89DDFF"}},"();")])])])],-1),bs={id:"std-promise",tabindex:"-1"},ws=s("p",null,"可以将一个值传递给一个新线程",-1),qs=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"auto"),s("span",{style:{color:"#A6ACCD"}}," task "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"[]("),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"future"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"f"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"    "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"cout "),s("span",{style:{color:"#89DDFF"}},"<<"),s("span",{style:{color:"#A6ACCD"}}," f"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"<<"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"flush"),s("span",{style:{color:"#89DDFF"}},";"),s("span",{style:{color:"#676E95","font-style":"italic"}}," // 阻塞，直到 p.set_value() 被调用")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"};")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"promise"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," p"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"thread t"),s("span",{style:{color:"#89DDFF"}},"{"),s("span",{style:{color:"#F07178"}}," task"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#A6ACCD"}},"p"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get_future"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"};")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"this_thread"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"sleep_for"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"chrono"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"seconds"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F78C6C"}},"5"),s("span",{style:{color:"#89DDFF"}},"));")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"p"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"set_value"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F78C6C"}},"5"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"t"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"join"),s("span",{style:{color:"#89DDFF"}},"();")])])])],-1),js={id:"std-shared-future",tabindex:"-1"},$s=s("p",null,[l("构造"),s("code",null,"shared_future"),l("的方法")],-1),Is=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"promise"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," p"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"future"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"f"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"p"),s("span",{style:{color:"#A6ACCD"}},"."),s("span",{style:{color:"#82AAFF"}},"get_future"),s("span",{style:{color:"#89DDFF"}},"());")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"shared_future"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"sf"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"move"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"f"),s("span",{style:{color:"#89DDFF"}},"));")])])])],-1),Ps=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"promise"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," p"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"shared_future"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"sf"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"p"),s("span",{style:{color:"#A6ACCD"}},"."),s("span",{style:{color:"#82AAFF"}},"get_future"),s("span",{style:{color:"#89DDFF"}},"());")])])])],-1),Ss=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"promise"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," p"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"auto"),s("span",{style:{color:"#A6ACCD"}}," sf "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," p"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"get_future"),s("span",{style:{color:"#89DDFF"}},"()."),s("span",{style:{color:"#82AAFF"}},"share"),s("span",{style:{color:"#89DDFF"}},"();")])])])],-1),Ws={id:"锁存器和栅栏",tabindex:"-1"},Ns={id:"std-latch",tabindex:"-1"},Ts=s("ul",null,[s("li",null,[l("计数器作为构造函数的唯一参数"),s("code",null,"std::latch la(3)")]),s("li",null,[s("code",null,"count_down()"),l("与"),s("code",null,"arrive_and_wait()"),l(" 令计数器减一，而后者会阻塞线程直到计数器为0")]),s("li",null,[s("code",null,"wait()"),l("阻塞线程，直到计数器为0")])],-1),Os={id:"std-barrier",tabindex:"-1"},Ls=s("ul",null,[s("li",null,[s("p",null,"计数器作为第一个参数，可调用对象(必须是noexcept)作为第二个参数(可选)，在barrier就绪(计数器为0)时， 其中一个线程调用。同时，返回值指定下一次的计数"),s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"barrier"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"b1"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F78C6C"}},"3"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"barrier"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"b2"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F78C6C"}},"3"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"[]()"),s("span",{style:{color:"#A6ACCD"}}," noexcept "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"cout "),s("span",{style:{color:"#89DDFF"}},"<<"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"this_thread"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"get_id"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"<<"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"endl"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"-"),s("span",{style:{color:"#F78C6C"}},"1"),s("span",{style:{color:"#89DDFF"}},";"),s("span",{style:{color:"#676E95","font-style":"italic"}}," // -1表示下一次计数不变")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"});")])])])])]),s("li",null,[s("p",null,[s("code",null,"arrive_and_wait()"),l("令计数器减一，并且阻塞线程")])]),s("li",null,[s("p",null,[s("code",null,"arrive()"),l("与"),s("code",null,"wait()"),l("，"),s("code",null,"b.arrive(b.wait())"),l("与"),s("code",null,"b.arrive_and_wait()"),l("等价")])]),s("li",null,[s("p",null,[s("code",null,"arrive_and_drop()"),l("，当前计数与下次barrier计数减一")]),s("blockquote",null,[s("p",null,"std::barrier可多次使用")])])],-1),Ms={id:"内存模型和原子操作",tabindex:"-1"},Us={id:"atomic",tabindex:"-1"},Vs=s("p",null,[l("atomic的操作都是原子的，有的是使用原子指令，有的使用互斥锁模拟原子操作，使用"),s("code",null,"x.is_lock_free()"),l(" 函数查询原子指令("),s("code",null,"is_lock_free()"),l("返回true)还是使用锁("),s("code",null,"is_lock_free()"),l("返回false)")],-1),Gs=s("p",null,[l("同时C++17中，所有原子类型有一个static constexpr成员变量"),s("code",null,"X::is_always_lock_free"),l("，值为true 表示无锁，false表示有锁")],-1),Rs={id:"std-atomic-flag",tabindex:"-1"},zs=s("blockquote",null,[s("p",null,"唯一确保为无锁的类型")],-1),Js=s("p",null,[s("code",null,"std::atomic_flag"),l("对象必须被"),s("code",null,"ATOMIC_FLAG_INIT"),l("初始化。初始化标志位为清除状态即false")],-1),Xs=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#FFCB6B"}},"spinlock_mutex")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"private"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#F07178"}},"atomic_flag flag"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#82AAFF"}},"spinlock_mutex"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#82AAFF"}},"flag"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F07178"}},"ATOMIC_FLAG_INIT"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#82AAFF"}},"lock"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    // test_and_set()设置标志位为true，并返回旧的标志位")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    // 第一次调用或着clear()后，才会返回false，从而调出循环")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"while"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"flag"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"test_and_set"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#F07178"}},"memory_order_acquire"),s("span",{style:{color:"#89DDFF"}},"));")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#82AAFF"}},"unlock"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    // 设置标志位为false")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#A6ACCD"}},"flag"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"clear"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#F07178"}},"memory_order_release"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"};")])])])],-1),Zs={id:"std-atomic-bool",tabindex:"-1"},Hs=s("p",null,[s("code",null,"load()"),l(", "),s("code",null,"store()"),l("与"),s("code",null,"exchange()")],-1),Ks=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"atd"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"atomic"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"bool"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," b"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"bool"),s("span",{style:{color:"#A6ACCD"}}," x "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," b"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"load"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"memory_order_acquire"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"b"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"store"),s("span",{style:{color:"#89DDFF"}},"(true);")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"// exchange()会返回旧值")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"x "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," b"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"exchange"),s("span",{style:{color:"#89DDFF"}},"(true,"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"memory_order_acq_rel"),s("span",{style:{color:"#89DDFF"}},");")])])])],-1),Qs=s("p",null,[s("code",null,"compare_exchange_weak()"),l("和"),s("code",null,"compare_exchange_strong()")],-1),Ys=s("blockquote",null,[s("p",null,[l("CAS即Compare And Swap，"),s("code",null,"compare_exchange_weak()"),l("与"),s("code",null,"compare_exchange_strong()"),l("是C++对CAS的实现")])],-1),sl=s("p",null,[s("code",null,"x.compare_exchange_strong(expected, desired)"),l("，如果x的原始值("),s("code",null,"*this"),l(")与期望值(expected)相同， 则令x的值为desired，并返回ture，如果不同，则x的值不变，并将值赋给expected，返回false")],-1),ll=s("blockquote",null,[s("p",null,"返回值true或false表示x的值是否变化，与期望值相同则改变，不同则没变")],-1),ol=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"bool"),s("span",{style:{color:"#A6ACCD"}}," expected "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"false;")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"extern"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"atomic"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"bool"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," b"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"b"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"compare_exchange_strong"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"expected"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"true))")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  ...")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")])])])],-1),el=s("p",null,[l("对于"),s("code",null,"compare_exchange_weak()"),l('来说，可能会出现"伪失败"，即'),s("code",null,"x.compare_exchange_weak(y, z)"),l("，在 x与y相等时，仍然返回false，且将x的值赋给y。所以通常在使用"),s("code",null,"compare_exchange_weak()"),l("时，都需要一个 循环")],-1),nl=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"// x与expected相等时，如果伪失败，将x的值赋给expected后，再进行一次CAS")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF","font-style":"italic"}},"while"),s("span",{style:{color:"#89DDFF"}},"(!"),s("span",{style:{color:"#A6ACCD"}},"x"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"compare_exchange_weak"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"expected"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," desired"),s("span",{style:{color:"#89DDFF"}},"));")])])])],-1),al={id:"std-atomic-t",tabindex:"-1"},tl=s("p",null,[l("提供+=、-=、++、--操作，同时"),s("code",null,"fetch_add()"),l("与"),s("code",null,"fetch_sub()"),l('在加、减的基础上返回原来的值，称为 "交换-相加"')],-1),cl=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#FFCB6B"}},"Widget"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{};")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"Widget a"),s("span",{style:{color:"#89DDFF"}},"["),s("span",{style:{color:"#F78C6C"}},"3"),s("span",{style:{color:"#89DDFF"}},"];")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"atmoic"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#A6ACCD"}},"Widget"),s("span",{style:{color:"#89DDFF"}},"*>"),s("span",{style:{color:"#A6ACCD"}}," p "),s("span",{style:{color:"#89DDFF"}},"{"),s("span",{style:{color:"#F07178"}},"a"),s("span",{style:{color:"#89DDFF"}},"};")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"Widget"),s("span",{style:{color:"#89DDFF"}},"*"),s("span",{style:{color:"#A6ACCD"}}," w1 "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," p"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"fetch_add"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F78C6C"}},"1"),s("span",{style:{color:"#89DDFF"}},");"),s("span",{style:{color:"#676E95","font-style":"italic"}}," // p加1，而w1是p的原始值")])])])],-1),rl={id:"std-atomic",tabindex:"-1"},pl={id:"原子操作的内存序",tabindex:"-1"},Fl=s("ol",null,[s("li",null,[s("code",null,"memory_order_relaxed")]),s("li",null,[s("code",null,"memory_order_consume")]),s("li",null,[s("code",null,"memory_order_acquire")]),s("li",null,[s("code",null,"memory_order_release")]),s("li",null,[s("code",null,"memory_order_acq_rel")]),s("li",null,[s("code",null,"memory_order_seq_cst")])],-1),yl=s("p",null,[l("除非指定一个选项，不然默认都是"),s("code",null,"memory_order_seq_cst")],-1),Dl=s("p",null,[l("6种选项代表三种内存模型：顺序一致性，获取-释放序("),s("code",null,"memory_order_consume"),l(", "),s("code",null,"memory_order_acquire"),l(", "),s("code",null,"memory_order_release"),l("和"),s("code",null,"memory_order_acq_rel"),l(")和自由序("),s("code",null,"memory_order_relaxed"),l(")")],-1),il=s("p",null,"memory order针对的是共享变量，可以是atomic也可以是non-atomic的，但一定是共享的，通过 memory order约定CPU操作变量的顺序",-1),dl={id:"顺序一致性",tabindex:"-1"},Al=s("ol",null,[s("li",null,"操作不重排，以源码的顺序执行"),s("li",null,"当前线程的操作顺序，对于其他线程可见")],-1),Cl=s("p",null,"producer的线程中的代码顺序不会改变，即3先行于4，该顺序对consumer可见。因此在运行1 时，知道先运行3再运行4",-1),ul=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"atomic"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"bool"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," ready "),s("span",{style:{color:"#89DDFF"}},"{"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"false"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"};")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"string work "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"consumer"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"while"),s("span",{style:{color:"#89DDFF"}},"(!"),s("span",{style:{color:"#A6ACCD"}},"ready"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"load"),s("span",{style:{color:"#89DDFF"}},"());"),s("span",{style:{color:"#676E95","font-style":"italic"}},"           // 1")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"cout "),s("span",{style:{color:"#89DDFF"}},"<<"),s("span",{style:{color:"#A6ACCD"}}," work "),s("span",{style:{color:"#89DDFF"}},"<<"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"endl"),s("span",{style:{color:"#89DDFF"}},";"),s("span",{style:{color:"#676E95","font-style":"italic"}}," // 2")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"producer"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  work "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#C3E88D"}},"done"),s("span",{style:{color:"#89DDFF"}},'"'),s("span",{style:{color:"#89DDFF"}},";"),s("span",{style:{color:"#676E95","font-style":"italic"}},"     // 3")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  ready"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"store"),s("span",{style:{color:"#89DDFF"}},"(true);"),s("span",{style:{color:"#676E95","font-style":"italic"}}," // 4")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"main"),s("span",{style:{color:"#89DDFF"}},"()")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"thread "),s("span",{style:{color:"#82AAFF"}},"t1"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"producer"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#A6ACCD"}},"thread "),s("span",{style:{color:"#82AAFF"}},"t2"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"consumer"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  t1"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"join"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  t2"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"join"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")])])])],-1),hl={id:"获取-释放序",tabindex:"-1"},_l=s("blockquote",null,[s("p",null,"在线程A上一个原子存储是释放操作，在线程B上对相同变量的原子加载时获得操作，且 线程B上的加载读取由线程A上的存储写入的值，则线程A上的存储Synchronizes-with(同步发生)线程B上的加载")],-1),ml=s("ul",null,[s("li",null,"不许acquire之后的操作重排到acquire之前，其他release同一原子变量的线程的所有 写入对当前线程可见"),s("li",null,"不许release之前的操作重排到release之后，当前线程的所有写入，可见于获得该同一 原子变量的其他线程")],-1),Bl=s("p",null,[l("关于"),s("code",null,"memory_order_consume"),l("，与"),s("code",null,"memory_order_acquire"),l("一样，必须与"),s("code",null,"memory_order_release"),l("一起使用， "),s("s",null,"然后就看不懂了，后续再补充")],-1),fl={id:"自由序",tabindex:"-1"},gl=s("p",null,"没有任何同步和重排限制",-1),kl={id:"栅栏",tabindex:"-1"},xl=s("p",null,[l("对于"),s("code",null,"lock()"),l("与"),s("code",null,"unlock()"),l("，可以看作两个单方向的屏障，"),s("code",null,"lock()"),l("只允许向下方移动， "),s("code",null,"unlock()"),l("只允许向上方移动")],-1),vl=s("p",null,[s("img",{src:"https://starrobe.oss-cn-beijing.aliyuncs.com/blog/move_out.png",alt:"move-out"})],-1),El=s("p",null,[s("img",{src:"https://starrobe.oss-cn-beijing.aliyuncs.com/blog/move_in.png",alt:"move-in"})],-1),bl=s("table",null,[s("thead",null,[s("tr",null,[s("th",{style:{"text-align":"left"}},"full fence"),s("th",{style:{"text-align":"left"}},"acquire fence"),s("th",{style:{"text-align":"left"}},"release fence")])]),s("tbody",null,[s("tr",null,[s("td",{style:{"text-align":"left"}},[s("code",null,"std::atomic_thread_fence()")]),s("td",{style:{"text-align":"left"}},[s("code",null,"std::atomic_thread_fence(std::memory_order_acquire)")]),s("td",{style:{"text-align":"left"}},[s("code",null,"std::atomic_thread_fence(std::memory_order_release)")])]),s("tr",null,[s("td",{style:{"text-align":"left"}},"避免重排(Store-Load除外)"),s("td",{style:{"text-align":"left"}},"避免栅栏前的读操作，被栅栏后的操作重排"),s("td",{style:{"text-align":"left"}},"避免栅栏前的写擦欧总，被栅栏前的操作重排")])])],-1),wl=s("p",null,[s("img",{src:"https://starrobe.oss-cn-beijing.aliyuncs.com/blog/fences.png",alt:"fences"})],-1),ql={id:"full-fence",tabindex:"-1"},jl=s("p",null,[s("img",{src:"https://starrobe.oss-cn-beijing.aliyuncs.com/blog/full_fence.png",alt:"full-fence"})],-1),$l={id:"acquire-fence",tabindex:"-1"},Il=s("p",null,[s("img",{src:"https://starrobe.oss-cn-beijing.aliyuncs.com/blog/acquire_fence.png",alt:"acquire-fence"})],-1),Pl={id:"release-fence",tabindex:"-1"},Sl=s("p",null,[s("img",{src:"https://starrobe.oss-cn-beijing.aliyuncs.com/blog/release_fence.png",alt:"release-fence"})],-1),Wl=s("hr",null,null,-1),Nl=s("p",null,[l("待续。。。"),s("s",null,"有时间再看后面的")],-1);function Tl(a,Ol,Ll,Ml,r,Ul){const e=C,p=F;return A(),d(p,{frontmatter:r.frontmatter,data:r.data},{"main-content-md":o(()=>[h,s("ul",null,[_,s("li",null,[l("译者："),n(e,{href:"https://github.com/xiaoweiChen",title:"github",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("xiaoweiChen")]),_:1})])]),s("h2",m,[l("线程管理 "),n(e,{class:"header-anchor",href:"#线程管理","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),B,f,s("h2",g,[l("共享数据 "),n(e,{class:"header-anchor",href:"#共享数据","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h3",k,[l("使用互斥保护数据 "),n(e,{class:"header-anchor",href:"#使用互斥保护数据","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h4",x,[l("std::mutex "),n(e,{class:"header-anchor",href:"#std-mutex","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),v,s("h5",E,[l("基本用法 "),n(e,{class:"header-anchor",href:"#基本用法","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),b,s("h5",w,[l("避免死锁 "),n(e,{class:"header-anchor",href:"#避免死锁","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),q,j,$,I,s("h4",P,[l("std::lock_guard<> "),n(e,{class:"header-anchor",href:"#std-lock-guard","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),S,W,N,T,s("h4",O,[l("std::scoped_lock<> "),n(e,{class:"header-anchor",href:"#std-scoped-lock","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),L,M,s("h4",U,[l("层级锁的实现 "),n(e,{class:"header-anchor",href:"#层级锁的实现","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),V,s("h4",G,[l("std::unique_lock<> "),n(e,{class:"header-anchor",href:"#std-unique-lock","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),R,z,s("h3",J,[l("保护数据的替代方案 "),n(e,{class:"header-anchor",href:"#保护数据的替代方案","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h4",X,[l("保护共享数据的初始化过程 "),n(e,{class:"header-anchor",href:"#保护共享数据的初始化过程","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Z,H,K,Q,Y,s("h4",ss,[l("保护不常更新的数据结构 "),n(e,{class:"header-anchor",href:"#保护不常更新的数据结构","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),ls,os,es,ns,s("h4",as,[l("嵌套锁 "),n(e,{class:"header-anchor",href:"#嵌套锁","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),ts,cs,s("h2",rs,[l("同步操作 "),n(e,{class:"header-anchor",href:"#同步操作","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h3",ps,[l("条件变量 "),n(e,{class:"header-anchor",href:"#条件变量","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Fs,ys,Ds,is,s("h3",ds,[l("future "),n(e,{class:"header-anchor",href:"#future","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),As,s("h4",Cs,[l("std::async "),n(e,{class:"header-anchor",href:"#std-async","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),us,hs,_s,ms,Bs,fs,s("h4",gs,[l("std::packaged_task<> "),n(e,{class:"header-anchor",href:"#std-packaged-task","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),ks,xs,vs,Es,s("h4",bs,[l("std::promise<> "),n(e,{class:"header-anchor",href:"#std-promise","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),ws,qs,s("h4",js,[l("std::shared_future<> "),n(e,{class:"header-anchor",href:"#std-shared-future","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),$s,Is,Ps,Ss,s("h3",Ws,[l("锁存器和栅栏 "),n(e,{class:"header-anchor",href:"#锁存器和栅栏","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h4",Ns,[l("std::latch "),n(e,{class:"header-anchor",href:"#std-latch","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Ts,s("h4",Os,[l("std::barrier "),n(e,{class:"header-anchor",href:"#std-barrier","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Ls,s("h2",Ms,[l("内存模型和原子操作 "),n(e,{class:"header-anchor",href:"#内存模型和原子操作","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h3",Us,[l("atomic "),n(e,{class:"header-anchor",href:"#atomic","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Vs,Gs,s("h4",Rs,[l("std::atomic_flag "),n(e,{class:"header-anchor",href:"#std-atomic-flag","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),zs,Js,Xs,s("h4",Zs,[l("std::atomic<bool> "),n(e,{class:"header-anchor",href:"#std-atomic-bool","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Hs,Ks,Qs,Ys,sl,ll,ol,el,nl,s("h4",al,[l("std::atomic<T*> "),n(e,{class:"header-anchor",href:"#std-atomic-t","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),tl,cl,s("h4",rl,[l("std::atomic<> "),n(e,{class:"header-anchor",href:"#std-atomic","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("h3",pl,[l("原子操作的内存序 "),n(e,{class:"header-anchor",href:"#原子操作的内存序","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Fl,yl,Dl,il,s("h4",dl,[l("顺序一致性 "),n(e,{class:"header-anchor",href:"#顺序一致性","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Al,Cl,ul,s("h4",hl,[l("获取-释放序 "),n(e,{class:"header-anchor",href:"#获取-释放序","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),_l,ml,Bl,s("h4",fl,[l("自由序 "),n(e,{class:"header-anchor",href:"#自由序","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),gl,s("h3",kl,[l("栅栏 "),n(e,{class:"header-anchor",href:"#栅栏","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),xl,vl,El,bl,wl,s("h4",ql,[l("full fence "),n(e,{class:"header-anchor",href:"#full-fence","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),jl,s("h4",$l,[l("acquire fence "),n(e,{class:"header-anchor",href:"#acquire-fence","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Il,s("h4",Pl,[l("release fence "),n(e,{class:"header-anchor",href:"#release-fence","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),Sl,Wl,Nl]),"main-header":o(()=>[t(a.$slots,"main-header")]),"main-header-after":o(()=>[t(a.$slots,"main-header-after")]),"main-nav":o(()=>[t(a.$slots,"main-nav")]),"main-content":o(()=>[t(a.$slots,"main-content")]),"main-content-after":o(()=>[t(a.$slots,"main-content-after")]),"main-nav-before":o(()=>[t(a.$slots,"main-nav-before")]),"main-nav-after":o(()=>[t(a.$slots,"main-nav-after")]),comment:o(()=>[t(a.$slots,"comment")]),footer:o(()=>[t(a.$slots,"footer")]),aside:o(()=>[t(a.$slots,"aside")]),"aside-custom":o(()=>[t(a.$slots,"aside-custom")]),default:o(()=>[t(a.$slots,"default")]),_:3},8,["frontmatter","data"])}const Zl=y(u,[["render",Tl]]);export{Xl as __pageData,Zl as default};
