import{_ as F}from"./ValaxyMain.vue_vue_type_style_index_0_lang-d8ab152d.js";import{_ as y,u as D,p as i,c as d,w as o,o as C,a as s,b as l,d as t,r as e,e as A}from"./app-2781ddff.js";import"./YunFooter.vue_vue_type_script_setup_true_lang-e8642e2c.js";import"./YunCard.vue_vue_type_script_setup_true_lang-7e7da48c.js";import"./YunPageHeader.vue_vue_type_script_setup_true_lang-ebad1ef6.js";const Q=JSON.parse('{"title":"无锁的线程安全栈","description":"","frontmatter":{"layout":"post","title":"无锁的线程安全栈","date":"2023-08-13T20:55:23.000Z","categories":"编程","tags":["C++","并发编程"]},"headers":[{"level":3,"title":"数据结构","slug":"数据结构","link":"#数据结构","children":[]},{"level":3,"title":"入栈","slug":"入栈","link":"#入栈","children":[]},{"level":3,"title":"出栈","slug":"出栈","link":"#出栈","children":[]},{"level":3,"title":"内存模型","slug":"内存模型","link":"#内存模型","children":[]}],"relativePath":"pages/posts/lock-free-stack.md","path":"/home/runner/work/valaxy/valaxy/pages/posts/lock-free-stack.md","lastUpdated":1692888211000}'),c=JSON.parse('{"title":"无锁的线程安全栈","description":"","frontmatter":{"layout":"post","title":"无锁的线程安全栈","date":"2023-08-13T20:55:23.000Z","categories":"编程","tags":["C++","并发编程"]},"headers":[{"level":3,"title":"数据结构","slug":"数据结构","link":"#数据结构","children":[]},{"level":3,"title":"入栈","slug":"入栈","link":"#入栈","children":[]},{"level":3,"title":"出栈","slug":"出栈","link":"#出栈","children":[]},{"level":3,"title":"内存模型","slug":"内存模型","link":"#内存模型","children":[]}],"relativePath":"pages/posts/lock-free-stack.md","path":"/home/runner/work/valaxy/valaxy/pages/posts/lock-free-stack.md","lastUpdated":1692888211000}'),u={name:"pages/posts/lock-free-stack.md",data(){return{data:c,frontmatter:c.frontmatter,$frontmatter:c.frontmatter}},setup(){const n=D();n.meta.frontmatter=Object.assign(n.meta.frontmatter,c.frontmatter),i("pageData",c)}},_=s("blockquote",null,[s("p",null,"选自《C++ Concurrency In Action》7.2.4")],-1),h={id:"数据结构",tabindex:"-1"},f=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"template"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"typename"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"T"),s("span",{style:{color:"#89DDFF"}},">")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#FFCB6B"}},"LockFreeStack"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#C792EA"}},"private"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#C792EA"}},"struct"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#FFCB6B"}},"Node"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#C792EA"}},"struct"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#FFCB6B"}},"CountNodePtr"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#F07178"}}," external_count"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    Node"),s("span",{style:{color:"#89DDFF"}},"*"),s("span",{style:{color:"#F07178"}}," ptr"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#89DDFF"}},"};")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#C792EA"}},"struct"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#FFCB6B"}},"Node"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#F07178"}},"shared_ptr"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"T"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#F07178"}}," data"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#F07178"}},"atomic"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#F07178"}}," internal_count"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    CountNodePtr next"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#82AAFF"}},"Node"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"const"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#FFCB6B"}},"T"),s("span",{style:{color:"#C792EA"}},"&"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"value"),s("span",{style:{color:"#89DDFF"}},")")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"        "),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#82AAFF"}},"data"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"make_shared"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#FFCB6B"}},"T"),s("span",{style:{color:"#89DDFF"}},">("),s("span",{style:{color:"#F07178"}},"value"),s("span",{style:{color:"#89DDFF"}},")),"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#82AAFF"}},"internal_count"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F78C6C"}},"0"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#89DDFF"}},"};")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#F07178"}},"atomic"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"CountNodePtr"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#F07178"}}," head"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"};")])])])],-1),m=s("blockquote",null,[s("p",null,[s("code",null,"std::atomic<CountNodePtr>"),l("超过8字节，"),s("s",null,"可能"),l("并不是无锁的，主要学习如何通过计数避免资源过早释放")])],-1),B={id:"为什么引用计数",tabindex:"-1"},E=s("p",null,"正常通过链表实现的无锁栈",-1),k=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"class"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#FFCB6B"}},"LockFreeStack"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"private"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#C792EA"}},"struct"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#FFCB6B"}},"Node"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#F07178"}},"shared_ptr"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"T"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#F07178"}}," data"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    Node"),s("span",{style:{color:"#89DDFF"}},"*"),s("span",{style:{color:"#F07178"}}," next"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#89DDFF"}},"};")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#F07178"}},"atomic"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"Node"),s("span",{style:{color:"#89DDFF"}},"*>"),s("span",{style:{color:"#F07178"}}," head"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"public"),s("span",{style:{color:"#89DDFF"}},":")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"shared_ptr"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#FFCB6B"}},"T"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#82AAFF"}},"pop"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    Node"),s("span",{style:{color:"#89DDFF"}},"*"),s("span",{style:{color:"#F07178"}}," old_head "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#A6ACCD"}},"head"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"load"),s("span",{style:{color:"#89DDFF"}},"();"),s("span",{style:{color:"#676E95","font-style":"italic"}}," // 1")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"while"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F07178"}},"old_head "),s("span",{style:{color:"#89DDFF"}},"&&"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"!"),s("span",{style:{color:"#A6ACCD"}},"head"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"compare_exchange_weak"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F07178"}},"old_head"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#A6ACCD"}},"old_head"),s("span",{style:{color:"#89DDFF"}},"->"),s("span",{style:{color:"#A6ACCD"}},"next"),s("span",{style:{color:"#89DDFF"}},"));"),s("span",{style:{color:"#676E95","font-style":"italic"}}," // 2")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#F07178"}},"shared_ptr"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"T"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#F07178"}}," res "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#F07178"}}," old_head "),s("span",{style:{color:"#89DDFF"}},"?"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#A6ACCD"}},"old_head"),s("span",{style:{color:"#89DDFF"}},"->"),s("span",{style:{color:"#A6ACCD"}},"data"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},":"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"make_shared"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#FFCB6B"}},"T"),s("span",{style:{color:"#89DDFF"}},">();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#89DDFF"}},"delete"),s("span",{style:{color:"#F07178"}}," old_head"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#F07178"}}," res"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"};")])])])],-1),g=s("p",null,[l("主要基于出栈时，线程a运行完步骤1后，线程b删除了该节点。因此线程a中的"),s("code",null,"old_head"),l("变成了 悬空指针(并不是nullptr，但指向的空间被释放)，而步骤2中，调用CAS前需要计算实参"),s("code",null,"old_head->next"),l("的值")],-1),v=s("p",null,"因此在确保没有线程使用该结点前，不能释放该结点，引用计数可以解决该问题",-1),x={id:"为什么拆分引用计数",tabindex:"-1"},w=s("p",null,[s("s",null,"还是看stackoverflow里老哥的回答吧，我也不明白为什么这么设计")],-1),N=s("p",null,"将计数分为两个阶段",-1),b=s("ol",null,[s("li",null,[s("p",null,[l("计数器被拆分("),s("code",null,"external_count"),l("与"),s("code",null,"internal_count"),l(")，两个的和才是结点的真正计数")]),s("ul",null,[s("li",null,"引用结点时，外部计数加一，结束访问时，内部计数减一"),s("li",null,[s("code",null,"external_count == -internal_count"),l("时，引用为0，删除结点")])])]),s("li",null,[s("p",null,"将外部计数加入到内部计数中，此时内部计数表示真正的计数"),s("p",null,"内部计数为0时，删除结点")])],-1),$=s("p",null,[l("当其他线程引用结点时，外部计数加一。如果没有内部计数，在不再引用时，会递减计数，此时就需要 与递增时一样("),s("code",null,"IncreaseHeadCount()"),l(")循环调用CAS")],-1),T={id:"入栈",tabindex:"-1"},P=s("ol",null,[s("li",null,[l("将当前结点的"),s("code",null,"next"),l("指向栈顶"),s("code",null,"head")]),s("li",null,[l("将当前结点设置为"),s("code",null,"head")])],-1),S=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"push"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#C792EA"}},"const"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#FFCB6B"}},"T"),s("span",{style:{color:"#C792EA"}},"&"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"value"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"  // 1. 创建结点，并计数")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  CountNodePtr new_node"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  new_node"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"ptr "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"new"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"Node"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"value"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  new_node"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"external_count "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#F78C6C"}},"1"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"  // 2. 将新结点的next指向head")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  new_node"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"ptr"),s("span",{style:{color:"#89DDFF"}},"->"),s("span",{style:{color:"#A6ACCD"}},"next "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," head"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"  // 3. 确保新结点的next指向的是最新的head")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"  // 并将新节点设为head")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"while"),s("span",{style:{color:"#89DDFF"}},"(!"),s("span",{style:{color:"#A6ACCD"}},"head"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"compare_exchange_weak"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"new_node"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"ptr"),s("span",{style:{color:"#89DDFF"}},"->"),s("span",{style:{color:"#A6ACCD"}},"next"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," new_node"),s("span",{style:{color:"#89DDFF"}},"));")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")])])])],-1),I={id:"出栈",tabindex:"-1"},q=s("p",null,[l("出栈就是将栈顶("),s("code",null,"head"),l(")的"),s("code",null,"next"),l("设为栈顶，然后删除旧的栈顶")],-1),H=s("div",{class:"language-cpp"},[s("span",{class:"copy"}),s("pre",{class:"shiki material-theme-palenight"},[s("code",null,[s("span",{class:"line"},[s("span",{style:{color:"#C792EA"}},"void"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"IncreaseHeadCount"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#FFCB6B"}},"CountNodePtr"),s("span",{style:{color:"#C792EA"}},"&"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#A6ACCD","font-style":"italic"}},"old_counter"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"  // new_counter只是个临时量")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  counted_node_ptr new_counter"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"do"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    new_counter "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#F07178"}}," old_counter"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#89DDFF"}},"++"),s("span",{style:{color:"#A6ACCD"}},"new_counter"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"external_count"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    // 如果head没变，head的外部计数加一")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    // 如果head改变，old_counter拷贝head，然后head的外部计数加一")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#89DDFF"}},"}"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"while"),s("span",{style:{color:"#89DDFF"}},"(!"),s("span",{style:{color:"#A6ACCD"}},"head"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"compare_exchange_strong"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"old_counter"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#A6ACCD"}}," new_counter"),s("span",{style:{color:"#89DDFF"}},"));")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  old_counter"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"external_count "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," new_counter"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"external_count"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#FFCB6B"}},"shared_ptr"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#FFCB6B"}},"T"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#82AAFF"}},"pop"),s("span",{style:{color:"#89DDFF"}},"()"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  CountNodePtr old_head "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#A6ACCD"}}," head"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"load"),s("span",{style:{color:"#89DDFF"}},"();")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#A6ACCD"}},"  "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"while"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F78C6C"}},"1"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#A6ACCD"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    // 获取头节点以及其外部计数")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#82AAFF"}},"IncreaseHeadCount"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F07178"}},"old_head"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    node"),s("span",{style:{color:"#89DDFF"}},"*"),s("span",{style:{color:"#F07178"}}," old_head_ptr "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#A6ACCD"}},"old_head"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"ptr"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"(!"),s("span",{style:{color:"#F07178"}},"old_head_ptr"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#82AAFF"}},"shared_ptr"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#FFCB6B"}},"T"),s("span",{style:{color:"#89DDFF"}},">();")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    // 某个线程(线程a)进入后，其他线程就无法获取到当前结点了")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    // 其他线程就两种情况:")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    // 1. 刚进入pop，还没有IncreaseHeadCount()，那就与当前节点无关了，加载的是另外的结点")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    // 2. 经过了IncreaseHeadCount()，引用的是与线程a相同的结点，此时只能结束对当前结点的引用")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"    // 内部计数减一，即执行else if的内容")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"head"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"compare_exchange_strong"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F07178"}},"old_head"),s("span",{style:{color:"#89DDFF"}},","),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#A6ACCD"}},"old_head_ptr"),s("span",{style:{color:"#89DDFF"}},"->"),s("span",{style:{color:"#A6ACCD"}},"next"),s("span",{style:{color:"#89DDFF"}},"))"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"      "),s("span",{style:{color:"#FFCB6B"}},"std"),s("span",{style:{color:"#89DDFF"}},"::"),s("span",{style:{color:"#F07178"}},"shared_ptr"),s("span",{style:{color:"#89DDFF"}},"<"),s("span",{style:{color:"#F07178"}},"T"),s("span",{style:{color:"#89DDFF"}},">"),s("span",{style:{color:"#F07178"}}," res"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"      "),s("span",{style:{color:"#A6ACCD"}},"res"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"swap"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"old_head_ptr"),s("span",{style:{color:"#89DDFF"}},"->"),s("span",{style:{color:"#A6ACCD"}},"data"),s("span",{style:{color:"#89DDFF"}},");")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"      // head不再引用该结点，因此减一")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"      // 当前的old_head也将要超出作用域，再次减一")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"      // 该代码好像有些误导，需要看下面的部分才能明白此处的含义")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"      "),s("span",{style:{color:"#C792EA"}},"const"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#C792EA"}},"int"),s("span",{style:{color:"#F07178"}}," count_increase "),s("span",{style:{color:"#89DDFF"}},"="),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#A6ACCD"}},"old_head"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#A6ACCD"}},"external_count"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"-"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#F78C6C"}},"2"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"      // 当前线程退出引用后，计数的第一阶段结束")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"      // 此时外部计数为external_count，而内部计数为internal_count - 2")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"      // 判断总计数 = external_count + (internal_count - 2)是否为0")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"      // 即判断internal_count == -(external_count - 2)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"      // 此处解释了上面count_increase的定义，以及下面的if判断")]),l(`
`),s("span",{class:"line"}),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"      // 计数进入第二阶段，将外部计数加入到内部计数")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"      // internal_count = (internal_count - 2) + external_count")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"      // 也就是internal_count.fetch_add(external_count - 2)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"      "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"old_head_ptr"),s("span",{style:{color:"#89DDFF"}},"->"),s("span",{style:{color:"#A6ACCD"}},"internal_count"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"fetch_add"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F07178"}},"count_increase"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"==")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"          "),s("span",{style:{color:"#89DDFF"}},"-"),s("span",{style:{color:"#F07178"}},"count_increase"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"        "),s("span",{style:{color:"#89DDFF"}},"delete"),s("span",{style:{color:"#F07178"}}," old_head_ptr"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"      "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"      "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"return"),s("span",{style:{color:"#F07178"}}," res"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#89DDFF"}},"}"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"else"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF","font-style":"italic"}},"if"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#A6ACCD"}},"old_head_ptr"),s("span",{style:{color:"#89DDFF"}},"->"),s("span",{style:{color:"#A6ACCD"}},"internal_count"),s("span",{style:{color:"#89DDFF"}},"."),s("span",{style:{color:"#82AAFF"}},"fetch_sub"),s("span",{style:{color:"#89DDFF"}},"("),s("span",{style:{color:"#F78C6C"}},"1"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"=="),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#F78C6C"}},"1"),s("span",{style:{color:"#89DDFF"}},")"),s("span",{style:{color:"#F07178"}}," "),s("span",{style:{color:"#89DDFF"}},"{")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"      // internal_count.fetch_sub(-1)很好理解，其他线程退出对当前结点的引用，详情见if(CAS)处的注释")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"      // 对于internal_count == 1的判断")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"      // 一般来说internal_count肯定为0或者负数，即线程退出结点的引用而递减")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"      // 当internal_count为正数时，表示当前节点的计数由内部计数来表达(计数的第二阶段)")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#676E95","font-style":"italic"}},"      // internal_count为1，表示只有当前线程持有该节点，因此退出引用，删除节点")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"      "),s("span",{style:{color:"#89DDFF"}},"delete"),s("span",{style:{color:"#F07178"}}," old_head_ptr"),s("span",{style:{color:"#89DDFF"}},";")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"    "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#F07178"}},"  "),s("span",{style:{color:"#89DDFF"}},"}")]),l(`
`),s("span",{class:"line"},[s("span",{style:{color:"#89DDFF"}},"}")])])])],-1),V={id:"内存模型",tabindex:"-1"},L=s("p",null,[s("s",null,"这部分更是重量级，个人水平有限")],-1);function O(n,J,U,Z,r,j){const a=A,p=F;return C(),d(p,{frontmatter:r.frontmatter,data:r.data},{"main-content-md":o(()=>[_,s("h3",h,[l("数据结构 "),t(a,{class:"header-anchor",href:"#数据结构","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),f,m,s("h4",B,[l("为什么引用计数 "),t(a,{class:"header-anchor",href:"#为什么引用计数","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),E,k,g,v,s("h4",x,[l("为什么拆分引用计数 "),t(a,{class:"header-anchor",href:"#为什么拆分引用计数","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),s("blockquote",null,[s("p",null,[t(a,{href:"https://stackoverflow.com/questions/67371033/how-does-the-split-reference-counting-work-in-a-lock-free-stack",target:"_blank",rel:"noreferrer"},{default:o(()=>[l("https://stackoverflow.com/questions/67371033/how-does-the-split-reference-counting-work-in-a-lock-free-stack")]),_:1})])]),w,N,b,$,s("h3",T,[l("入栈 "),t(a,{class:"header-anchor",href:"#入栈","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),P,S,s("h3",I,[l("出栈 "),t(a,{class:"header-anchor",href:"#出栈","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),q,H,s("h3",V,[l("内存模型 "),t(a,{class:"header-anchor",href:"#内存模型","aria-hidden":"true"},{default:o(()=>[l("#")]),_:1})]),L]),"main-header":o(()=>[e(n.$slots,"main-header")]),"main-header-after":o(()=>[e(n.$slots,"main-header-after")]),"main-nav":o(()=>[e(n.$slots,"main-nav")]),"main-content":o(()=>[e(n.$slots,"main-content")]),"main-content-after":o(()=>[e(n.$slots,"main-content-after")]),"main-nav-before":o(()=>[e(n.$slots,"main-nav-before")]),"main-nav-after":o(()=>[e(n.$slots,"main-nav-after")]),comment:o(()=>[e(n.$slots,"comment")]),footer:o(()=>[e(n.$slots,"footer")]),aside:o(()=>[e(n.$slots,"aside")]),"aside-custom":o(()=>[e(n.$slots,"aside-custom")]),default:o(()=>[e(n.$slots,"default")]),_:3},8,["frontmatter","data"])}const W=y(u,[["render",O]]);export{Q as __pageData,W as default};
